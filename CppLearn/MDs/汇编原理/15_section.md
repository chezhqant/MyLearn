## 第15章 外中断      
1.  CPU在计算机系统中，除了能够执行指令，进行运算之外，还应该能够对外部设备进行控制，接受他们的输入，向它们进行输出。也就是说，CPU除了有运算能力之外，还要有I/O能力。比如我们按下键盘上的一个键，CPU最终要能够处理这个键。在是用文本编辑器时，按下a键后，我们可以看到屏幕上出现"a"，是CPU将从键盘上输入的键所对应的字符送到显示器上的。     
2.  要及时处理外设的输入，显然需要解决两个问题：一是外设的输入随时可能发生，CPU如何得知？二是CPU从何处得到外设的输入？     
3.  在PC系统的接口卡和主板上，装有各种接口芯片。这些外设接口芯片的内部有若干寄存器，CPU将这些寄存器当作端口来访问。      
4.  外设的输出也不是直接送入内存和CPU，而是送入相关的接口芯片的端口中。CPU向外设的输出也不是直接送入外设，而是先送入端口中，再由相关的芯片送到外设。CPU还可以向外设输出控制命令，而这些空空告知命令也是先送到相关芯片的端口中，然后再由相关的芯片根据命令对外设实施控制。      
5.  CPU通过端口和外部设备进行联系。     
6.  外设的输入被存放在端口中，科室外设的输入随时都可能到达，CPU如何及时的知道，并进行处理？更一般的，就是外设随时都可能发生需要CPU及时处理的时间，CPU如何即使得知并进行处理？      
    CPU提供中断机制来满足这种需要，当CPU的内部有需要处理的事情发生的时候，将产生中断信息，引发中断过程。这种中断信息来自CPU的内部。      
    还有一种中断信息，来自于CPU外部，当CPU外部有需要处理的事情发生的时候，比如说，外设的输入到达，相关芯片将向CPU发出相应的中断信息。CPU在执行完当前指令后，可以检测到发送过来的中断信息，引发中断过程，处理外设的输入。     
7.  在PC系统中，外中断源共有两类：      
    + 可屏蔽中断  可屏蔽中断是CPU可以不信啊供应的外中断。CPU是否相应可屏蔽中断，要看标志寄存器IF位的设置。当CPU检测到可屏蔽中断信息的时候，如果IF=1，则CPU在执行完当前指令后相应中断，引发中断过程。如果IF=0，则不响应可屏蔽中断。     
      回忆内中断所引发的中断过程：      
      + 取中断类型码n       
      + 标志寄存器入栈，IF=0，TF=0      
      + CS、IP入栈      
      + (IP)=(nx4)，(CS)=(nx4+2)        
      由此转去执行中断处理程序      
      可屏蔽中断所引发的中断过程，除了在第一步的实现上有所不同外，基本上和内中断的中断过程相同。因为可屏蔽中断信息来自于CPU外部，中断类型码时通过数据总线送入CPU的；而内中断的中断类型码时CPU内部产生的。所以中断过程需要将IF置为0。原因是在进入中断处理程序后，禁止其他的可屏蔽中断。      
      如果在中断处理程序中需要处理可屏蔽中断，可以用指令IF置为1.8086CPU提供的设置IF的指令如下：     
      ```
      sti, 用于设置IF=1
      cli, 用于设置IF=0
      ```
    + 不可屏蔽中断 不可屏蔽中断是CPU必须相应的外中断。当CPU检测到不可屏蔽中断信息时，则在执行完当前指令后，立即响应，引发中断过程。      
      对于8086CPU，不可屏蔽中断的中断类型码固定为2，所以中断过程汇总，不需要取中断类型码。则不可屏蔽中断的中断过程为：   
      + 标志寄存器入栈，IF=0，TF=0      
      + CS、IP入栈      
      + (IP)=(8)，(CS)=(OAH)      
      几乎所有由外设引发的外中断，都是可屏蔽中断。当外设有需要处理的事件（比如说键盘输入）发生时，相关芯片向CPU发出可屏蔽中断信息。不可屏蔽中断是在系统中又必须处理的紧急情况发生时，用来通知CPU的中断信息。      
8.  键盘输入 键盘上的每个键相当于一个开关，键盘中有一个芯片对键盘上的每个键的开关状态进行扫描。按下一个键，开关接通，该芯片产生一个扫描码，扫描码说明了按下的键在键盘上的位置。扫描码被送入主板上的相关接口芯片的寄存器中，该寄存器的端口地址为60H。松开按下的键时，也产生了一个扫描码，扫描码说明了松开的键在键盘上的位置。松开按键时产生的扫描码也被送入60H端口中。一般将按下一个键时产生的扫描码称为通码，松开一个键产生的扫描码称为断码。扫描码长度为一个字节，通码的第7位为0，断码的第7位为1：断码=通码+80H。比如g键的通码为22H，断码为a2H。
    ![alt 键盘上键的扫描码](../../键盘上键的扫描码.PNG 键盘上键的扫描码)        
