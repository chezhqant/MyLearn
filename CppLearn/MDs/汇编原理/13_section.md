## 第十三章 int 指令 -- 另外一种内中断      
1.  int 指令的格式： `int n`，`n` 为中断类型码，它的功能是引发中断过程。       
2.  CPU执行 `int n` 指令，相当于引发一个n号中断的中断过程，执行过程如下：     
    + 取中断类型码n     
    + 标志寄存器入栈：IF=0，TF=0      
    + CS、IP入栈      
    + (IP)=(nx4)，(CS)=(nx4+2)        
    从此处转去执行n号中断的中断处理程序。可以在程序中是用int指令调用任何一个中断处理程序：     
    ```
    assume cs:code
    code segment
    start: mov ax, 0b800H
           mov es, ax
           mov byte ptr es:[12*160+40*2], '!'
           int 0
    code ends
    end start
    ```
    上述程序在windows2000中的DOS方式下执行时，将在屏幕上显示一个'!'，然后显示"Divide overflow"后返回系统中。"!"是我们编程显示的，而"Divide overflow" 是哪里来的呢？这是因为我们在结尾处是用了 `int 0` 指令。CPU执行 `int 0` 指令时，将引发中断过程，执行0号中断处理程序，而系统设置的0号中断处理程序的功能是显示"Divide overflow"，然后返回到系统。可见，int指令的最终功能和call指令相思，都是调用一段程序。我们可以将中断处理程序简称为中断例程。  
3.  [示例一](./demo_1.md)       
4.  [示例二](./demo_2.md)     
5.  在系统板的ROM中存放着一套程序，称为BIOS(基本输入输出系统)，BIOS中主要包含一下几部分内容：     
    + 硬件系统的检测和初始化程序    
    + 外部中断和内部中断的中断例程      
    + 用于对硬件设备进行I/O操作的中断例程     
    + 其他和硬件系统相关的中断例程      
    操作系统DOS也提供了中断例程，从操作系统的角度，DOS的中断例程就是操作系统向程序员提供的编程资源。     
    BIOS和DOS在所提供的中断例程中包含了许多子程序，这些子程序实现了程序员在编程的时候经常需要用到的功能，程序员在编程的时候，可以用int指令直接调用BIOS和DOS提供的中断例程，来完成某些工作。和硬件设备相关的DOS中断例程中，一般都调用了BIOS的中断例程。      
6.  BIOS和DOS提供的中断例程是如何安装到内存中的呢：       
    + 开机后，CPU一加电，初始化(CS)=0FFFFH，(IP)=0，自动从FFFF:0单元开始执行程序。FFFF:0处有一条跳转指令，CPU执行该指令后，转去执行BIOS中的硬件系统检测和初始化程序      
    + 初始化程序将建立BIOS所支持的中断向量，即将BIOS提供的中断例程的入口地址登记在中断向量表中。注意，对于BIOS所提供的中断例程，只需要将入口地址登记在中断向量表中即可，因为他们是固化到ROM中的程序，一直在内存中存在。      
    + 硬件系统检测和初始化完成后，调用 `int 19H` 进行操作系统的引导。从此将计算机交由操作系统控制。     
    + DOS启动后，除完成其他工作外，还将它所提供的中断例程装入内存中，并建立相应的中断向量。       
7.  BOIS中断例程的应用：    
    + `int 10H` 中断例程是BIOS提供的中断例程，其中包含了多个与屏幕输出相关的子程序。一般来说，一个供程序员调用的中断例程中往往包含多个子程序，中断例程内部用传递进来的参数来决定执行哪一个子程序。BIOS和DOS提供的中断例程，都用ah来传递内部子程序的编号。      
    + `int 10` 中断例程的设置光标位置功能：     
    ```
    mov ah, 2       ; 设置光标
    mov bh, 0       ; 第0页
    mov dh, 5       ; dh中放行号
    mov dl, 12      ；dl中放列号
    int 10H
    ```
    (ah)=2表示调用第10H号中断例程的2号子程序，功能为设置光标位置，可以提供光标所在的行号（80x25字符模式下：0-24），列号（80x25字符模式下：0-79），和页号作为参数。(bh)=0, (dh)=5, (dl)=12，设置光标到第0页，第5行，第12列。        
    bh中页号的含义：内存地址空间中，B80000H-BFFFFH共32K的空间，为80x25彩色字符模式的显示缓冲区，一屏的内容显示缓冲区中共占用4000个字节。显示缓冲区分为8页，每页4K，显示器可以显示任意一页的内容。一般情况下显示第0页的内容。也就是说，通常情况下，B8000-B8F9F中的4000个字节的内容将出现在显示器上。再看一下 `int 10H` 中断例程的在光标位置显示字符功能：      
    ```
    mov ah, 9     ; 置光标
    mov al, 'a'   ; 字符
    mov bl, 7     ; 颜色属性
    mov bh, 0     ; 第0页
    mov cx, 3     ; 字符重复个数
    int 10H
    ```
    (ah)=9表示调用第 `10H` 号中断例程的9号子程序，功能为在光标位置显示字符，可以提供要显示的字符、颜色属性、页号、自负重复个数作为参数。bh中的颜色属性的格式如下：      
    ![alt bh中的颜色属性](../../pictures/bh中的颜色属性.PNG "bh中的颜色属性")       
    可以看出，和显存中的属性字节的格式相同。      
8.  编程：在屏幕的5行12列显示3个红色高亮闪烁绿色的 'a'      
    ```
    assume cs:code
    code segment
      mov ah, 2     ; 置光标
      mov bh, 0     ; 第0页
      mov dh, 5     ; dh中放行号
      mov dl, 12    ; dl中放列号
      int 10H

      mov ah, 9     ; 置光标
      mov al, 'a'   ; 字符
      mov bl, 11001010b ; 颜色属性
      mov bh, 0     ; 第0页
      mov cx, 3     ; 字符重复个数
      int 10H

      mov ax, 4c00H
      int 21H
    code ends
    end
    ```
9.  `int 21H` 中断例程是DOS提供的中断例程，其中包含了DOS提供给程序员在编程时调用的子程序。我们之前一直是用的是 `int 21H` 中断例程的4cH号功能，即程序返回功能：     
    ```
    mov ah, 4cH     ; 程序返回
    mov al, 0       ; 返回值
    int 21H
    ```
    (ah)=4cH表示调用第21H号中断例程的4cH号子程序，功能为程序返回，可以提供返回值作为参数。我们前面是用这个功能的时候经常写作：      
    ```
    mov ax, 4c00H
    int 21H
    ```
    看一下 `int 21H` 中断例程在光标位置显示字符串功能：   
    ```
    ds:dx 指向字符串      ; 要显示的字符串需用"$"作为结束符
    mov ah, 9             ; 功能号9， 表示光标位置显示字符串
    int 21H
    ```
    (ah)=9表示调用第21H号中断例程的9号子程序，功能为在光标位置显示字符串，可以提供要显示字符串的地址作为参数。       
10.  编程：在屏幕的5行12列显示字符串“Welcome to masm!”      
     ```
     assume cs:code
     data segment
       db 'Welcom to masm', '$'
     data ends

     code segment
     start: mov ah, 2   ; 置光标
            mov bh, 0          ; 第0页
            mov dh, 5          ; dh中放行号
            mov dl, 12         ; dl中放列号
            int 10H

            mov ax, data
            mov ds, ax
            mov dx, 0           ; ds:dx指向字符串的首地址data:0
            mov ah, 9
            int 21H

            mov ax, 4c00H
            int 21H

     code ends
     end start
     ```
     上述程序在屏幕的5行12列显示字符串“Welcome to masm!”，直到遇见“$”（“$”本身并不显示，只能起到边界的作用）。如果字符串比较长，遇到行尾，程序会自动转到下一行开头处继续显示；如果到了最后一行，还能自动上卷一行。   
     DOS 为程序员提供了许多可以调用的子程序，都包含在 `int 21H` 中断例程中        
